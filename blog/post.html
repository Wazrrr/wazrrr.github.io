<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post — Ziren Wang</title>
  <meta name="description" content="Blog post" />
  <link rel="stylesheet" href="/assets/styles.css">

  <!-- Markdown renderer + sanitizer (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- Optional: code highlighting -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
  <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
</head>
<body>
  <header>
    <h1>Ziren Wang</h1>
    <nav aria-label="Primary">
      <a href="/index.html">About</a>
      <a href="/index.html#publications">Publications</a>
      <a href="/index.html#projects">Projects</a>
      <a href="/blog/index.html" style="text-decoration:underline;opacity:1">Blogs</a>
      <a href="/cv/index.html">CV</a>
      <a href="/index.html#contact">Contact</a>
    </nav>
  </header>

  <main id="content" class="prose" style="min-height:40vh; padding-top:28px;">
    <h2 id="post-title" style="margin-top:0">Loading…</h2>
    <div id="post-meta" class="article-meta"></div>
    <article id="post-body"></article>
  </main>

  <footer>
    © <span id="year"></span> Ziren Wang
  </footer>

  <script>
    // Basic page chrome
    document.getElementById('year').textContent = new Date().getFullYear();
    // helper to tell if hljs is ready
    function hasHLJS() { return !!(window.hljs); }
    // Configure marked (GitHub-like)
    marked.setOptions({
      gfm: true,
      breaks: false,
      headerIds: true,
      mangle: false,
      highlight: (code, lang) => {
        try { return hljs.highlight(code, {language: lang}).value; }
        catch { return hljs.highlightAuto(code).value; }
      }
    });

    // Helper: get ?p=hello-world.md
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Simple guard: only allow filenames like "name.md" in assets/posts/
    function safePath(p) {
      if (!p) return null;
      if (p.includes("..") || p.startsWith("/") || p.includes("\\"))
        return null;
      if (!p.endsWith(".md")) return null;
      return "/assets/posts/" + p;
    }

    async function loadMarkdown() {
      const p = getParam("p") || "hello-world.md"; // default
      const url = safePath(p);
      const titleEl = document.getElementById("post-title");
      const metaEl = document.getElementById("post-meta");
      const bodyEl = document.getElementById("post-body");
      if (!url) {
        titleEl.textContent = "Invalid post path";
        return;
      }

      try {
        const res = await fetch(encodeURI(url), { cache: "no-store" });
        if (!res.ok) throw new Error("Not found");
        const raw = await res.text();

        // Optional: parse first heading as title & next line as date
        let title = null, date = null, md = raw.trim();

        // If file starts with front matter, you can extend this to parse it.
        // For now, we infer from first lines:
        const lines = md.split("\n");
        if (lines[0].startsWith("# ")) {
          title = lines[0].replace(/^# +/, "").trim();
          lines.shift();
          // If second line looks like a date, use it as meta
          if (/^\d{4}-\d{2}-\d{2}/.test(lines[0])) {
            date = lines[0].trim();
            lines.shift();
          }
          md = lines.join("\n").trim();
        }

        titleEl.textContent = title || document.title.replace(/^Post —\s*/, "") || "Untitled";
        if (date) metaEl.textContent = new Date(date).toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});

        // Render -> sanitize -> inject
        const html = marked.parse(md);
        bodyEl.innerHTML = DOMPurify.sanitize(html);

        // Update document title
        if (title) document.title = title + " — Ziren Wang";

        // Re-run hljs on inserted content, in case highlight() fallback wasn't used
        // Re-run highlighting on inserted blocks — *defensively*
      const blocks = bodyEl.querySelectorAll('pre code');
      if (hasHLJS()) {
        console.info("adjs")
        if (hljs.highlightElement) {
          blocks.forEach(b => hljs.highlightElement(b));
        } else if (hljs.highlightBlock) { // legacy API
          blocks.forEach(b => hljs.highlightBlock(b));
        }
      }
      } catch (e) {
        titleEl.textContent = "Post not found";
        document.getElementById("post-body").innerHTML = "<p>Sorry, that post couldn’t be loaded. Error: " + e.message + "</p>";
      }
    }

    loadMarkdown();
  </script>
</body>
</html>
